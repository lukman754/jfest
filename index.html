<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Event</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-link {
            word-break: break-all;
            white-space: normal;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Jadwal Event Indonesia</h1>

        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control"
                    placeholder="Cari berdasarkan nama acara, lokasi, atau area">
            </div>
            <div class="col-md-4">
                <select id="monthFilter" class="form-select">
                    <option value="">Semua Bulan</option>
                </select>
            </div>
            <div class="col-md-4">
                <select id="areaFilter" class="form-select">
                    <option value="">Semua Area</option>
                </select>
            </div>
        </div>

        <!-- Card Container -->
        <div class="row" id="card-container"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SPREADSHEET_URL =
            'https://docs.google.com/spreadsheets/d/1RQ2PZMRKjBVHpG0ettmuiDjjxzpF7OfFDfXlJDT0ElE/gviz/tq';

        let allEvents = []; // Store all events globally
        let uniqueAreas = new Set(); // Store unique areas
        let uniqueMonths = new Set(); // Store unique months

        window.google = {
            visualization: {
                Query: {
                    setResponse: function (data) {
                        processSheetData(data);
                    }
                }
            }
        };

        function fetchGoogleSheetData() {
            const script = document.createElement('script');
            script.src = SPREADSHEET_URL;
            document.body.appendChild(script);
        }

        function extractMonthFromDate(dateString) {
            // Check if dateString is valid and contains a month
            if (!dateString || dateString === '-') return null;

            // Split the date and extract month
            const parts = dateString.split(' ');
            return parts.length > 1 ? parts[1] : null;
        }

        function processSheetData(response) {
            const cardContainer = document.getElementById('card-container');
            const areaFilter = document.getElementById('areaFilter');
            const monthFilter = document.getElementById('monthFilter');

            cardContainer.innerHTML = ''; // Clear previous content
            areaFilter.innerHTML = '<option value="">Semua Area</option>'; // Reset area filter
            monthFilter.innerHTML = '<option value="">Semua Bulan</option>'; // Reset month filter

            uniqueAreas.clear(); // Clear previous unique areas
            uniqueMonths.clear(); // Clear previous unique months

            // Parse rows
            const rows = response.table.rows;
            allEvents = []; // Reset global events array

            rows.forEach(row => {
                // Extract values from the row, handling potential null values
                const tanggal = row.c[0] ? row.c[0].f : '-';
                const jam = row.c[1] ? (row.c[1].f || '-') : '-';
                const lokasi = row.c[2] ? row.c[2].v : '-';
                const area = row.c[3] ? row.c[3].v : '-';
                const namaAcara = row.c[4] ? row.c[4].v : '-';
                const lastUpdate = row.c[5] ? row.c[5].f : '-';
                const linkAcara = row.c[6] ? row.c[6].v : '#';

                // Add area to unique areas
                if (area !== '-') {
                    uniqueAreas.add(area);
                }

                // Extract and add month to unique months
                const month = extractMonthFromDate(tanggal);
                if (month) {
                    uniqueMonths.add(month);
                }

                // Store event data
                allEvents.push({
                    tanggal,
                    jam,
                    lokasi,
                    area,
                    namaAcara,
                    lastUpdate,
                    linkAcara
                });

                // Create Card
                createEventCard({
                    tanggal,
                    jam,
                    lokasi,
                    area,
                    namaAcara,
                    lastUpdate,
                    linkAcara
                });
            });

            // Populate area filter dropdown
            uniqueAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });

            // Populate month filter dropdown
            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });

            // Add event listeners for search, month, and area filters
            document.getElementById('searchInput').addEventListener('input', filterEvents);
            document.getElementById('monthFilter').addEventListener('change', filterEvents);
            document.getElementById('areaFilter').addEventListener('change', filterEvents);
        }

        function createEventCard(event) {
            const cardContainer = document.getElementById('card-container');
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4';
            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">${event.namaAcara}</h5>
                        <p class="card-text">
                            <strong>Tanggal:</strong> ${event.tanggal}<br>
                            <strong>Jam:</strong> ${event.jam}<br>
                            <strong>Lokasi:</strong> ${event.lokasi}<br>
                            <strong>Area:</strong> ${event.area}<br>
                            <small><strong>Last Update:</strong> ${event.lastUpdate}</small>
                        </p>
                        <a href="${event.linkAcara}" target="_blank" class="btn btn-primary card-link">Lihat Selengkapnya</a>
                    </div>
                </div>
            `;
            cardContainer.appendChild(card);
        }

        function filterEvents() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const monthFilter = document.getElementById('monthFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;

            const cardContainer = document.getElementById('card-container');
            cardContainer.innerHTML = ''; // Clear previous content

            // Filter events based on search, month, and area
            const filteredEvents = allEvents.filter(event => {
                const matchesSearch =
                    event.namaAcara.toLowerCase().includes(searchInput) ||
                    event.lokasi.toLowerCase().includes(searchInput) ||
                    event.area.toLowerCase().includes(searchInput);

                const matchesMonth =
                    monthFilter === '' ||
                    (event.tanggal && event.tanggal.includes(monthFilter));

                const matchesArea =
                    areaFilter === '' ||
                    event.area === areaFilter;

                return matchesSearch && matchesMonth && matchesArea;
            });

            // Create cards for filtered events
            filteredEvents.forEach(createEventCard);

            // Show message if no events found
            if (filteredEvents.length === 0) {
                cardContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center" role="alert">
                            Tidak ada event yang ditemukan
                        </div>
                    </div>
                `;
            }
        }

        // Fetch the data
        fetchGoogleSheetData();
    </script>
</body>

</html>
